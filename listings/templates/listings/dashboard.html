{% extends "listings/base.html" %}
{% load static %}
{% load humanize %}
{% block content %}

{# safe JSON for JS #}
{{ avg_by_location|json_script:"avg_by_location_data" }}

<div class="card shadow-sm p-4 mx-auto" style="max-width:1100px;">

  <!-- HEADER -->
  <div class="d-flex justify-content-between align-items-start mb-4">
    <div>
      <h3 class="mb-0">Dashboard</h3>
      <small class="text-muted">Prediction insights & analytics</small>
    </div>
    <div class="text-end">
      <div><strong>Total predictions:</strong> {{ total }}</div>
      <div><strong>Average price:</strong> ₹{{ avg_price|floatformat:2|intcomma }}</div>
    </div>
  </div>

  <div class="row">

    <!-- BAR CHART -->
    <div class="col-md-7 mb-4">
      <h5 class="mb-2">Average Price by Location</h5>

      {% if avg_by_location %}
        <div style="height:360px;">
          <canvas id="locBarChart"></canvas>
        </div>

        <ul class="list-group list-group-flush mt-3">
          {% for loc, avg in avg_by_location|slice:":8" %}
          <li class="list-group-item d-flex justify-content-between">
            <span>{{ loc }}</span>
            <span class="fw-semibold">₹{{ avg|floatformat:2|intcomma }}</span>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted">No prediction data available.</p>
      {% endif %}
    </div>

    <!-- PIE CHART -->
    <div class="col-md-5 mb-4">
      <h5 class="mb-2">Location-wise Distribution</h5>

      {% if avg_by_location %}
        <div style="height:360px;">
          <canvas id="locPieChart"></canvas>
        </div>
      {% else %}
        <p class="text-muted">No data to visualize.</p>
      {% endif %}
    </div>

  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
(function(){

  function safeParse(id){
    const el = document.getElementById(id);
    if(!el) return null;
    try { return JSON.parse(el.textContent); }
    catch(e){ return null; }
  }

  const avgData = safeParse("avg_by_location_data");

  if(avgData && avgData.length > 0){

    const labels = avgData.map(x => String(x[0] || "Unknown"));
    const values = avgData.map(x => Number(x[1] || 0));

    /* -------- BAR CHART -------- */
    new Chart(document.getElementById("locBarChart"), {
      type: "bar",
      data: {
        labels: labels,
        datasets: [{
          label: "Average Price (₹)",
          data: values,
          backgroundColor: "#0d6efd"
        }]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          x: {
            ticks: {
              callback: value => "₹" + Number(value).toLocaleString("en-IN")
            }
          }
        }
      }
    });

    /* -------- PIE CHART -------- */
    new Chart(document.getElementById("locPieChart"), {
      type: "pie",
      data: {
        labels: labels,
        datasets: [{
          data: values,
          backgroundColor: [
            "#0d6efd","#198754","#dc3545",
            "#ffc107","#6f42c1","#20c997",
            "#fd7e14","#0dcaf0"
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: "bottom"
          }
        }
      }
    });
  }

})();
</script>

{% endblock %}